.job_template_deploy:
  stage: deploy
  image:
    name: gitlab.com/shortlink-org/dependency_proxy/containers/alpine/helm:3.4.1
    entrypoint: [""]
  before_script:
    - docker login -u "$CI_DEPENDENCY_PROXY_USER" -p "$CI_DEPENDENCY_PROXY_PASSWORD" "$CI_DEPENDENCY_PROXY_SERVER"
  script:
    - env
    - helm upgrade $RELEASE_NAME $HELM_PATH $HELM_ARG
      --install
      --wait
      --namespace=$KUBE_NAMESPACE
      --create-namespace=true
      --set deploy.image.tag=$CI_COMMIT_TAG
      --set deploy.image.repository=$REGISTRY
      --set deploy.annotations."app\.gitlab\.com\/app"=$CI_PROJECT_PATH_SLUG,deploy.annotations."app\.gitlab\.com\/env"=$CI_ENVIRONMENT_SLUG;
  retry: 2
